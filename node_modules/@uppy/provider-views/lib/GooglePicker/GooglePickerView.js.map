{"version":3,"names":["h","useCallback","useEffect","useRef","useState","authorize","ensureScriptsInjected","InvalidTokenError","logout","pollPickingSession","showDrivePicker","showPhotosPicker","AuthView","GoogleDriveIcon","GooglePhotosIcon","useStore","store","key","value","setValueState","getItem","setValue","v","removeItem","setItem","GooglePickerView","_ref","uppy","i18n","clientId","onFilesPicked","pickerType","apiKey","appId","storage","loading","setLoading","accessToken","setAccessTokenStored","pickingSessionRef","accessTokenRef","shownPickerRef","setAccessToken","t","log","current","showPicker","signal","newAccessToken","doShowPicker","token","onPickingSessionChange","newPickingSession","pickingSession","Error","err","type","abortController","AbortController","onError","abort","undefined","handleLogoutClick","pluginName","pluginIcon","handleAuth","style","textAlign","className","display","marginBottom","disabled","onClick"],"sources":["GooglePickerView.tsx"],"sourcesContent":["import { h } from 'preact'\nimport { useCallback, useEffect, useRef, useState } from 'preact/hooks'\n\nimport type { Uppy, AsyncStore } from '@uppy/core'\n\nimport type { I18n } from '@uppy/utils/lib/Translator'\n\nimport {\n  authorize,\n  ensureScriptsInjected,\n  InvalidTokenError,\n  logout,\n  pollPickingSession,\n  showDrivePicker,\n  showPhotosPicker,\n  type PickedItem,\n  type PickingSession,\n} from './googlePicker.js'\nimport AuthView from '../ProviderView/AuthView.js'\nimport { GoogleDriveIcon, GooglePhotosIcon } from './icons.js'\n\nfunction useStore(\n  store: AsyncStore,\n  key: string,\n): [string | undefined | null, (v: string | null) => Promise<void>] {\n  const [value, setValueState] = useState<string | null | undefined>()\n  useEffect(() => {\n    ;(async () => {\n      setValueState(await store.getItem(key))\n    })()\n  }, [key, store])\n\n  const setValue = useCallback(\n    async (v: string | null) => {\n      setValueState(v)\n      if (v == null) {\n        return store.removeItem(key)\n      }\n      return store.setItem(key, v)\n    },\n    [key, store],\n  )\n\n  return [value, setValue]\n}\n\nexport type GooglePickerViewProps = {\n  uppy: Uppy<any, any>\n  i18n: I18n\n  clientId: string\n  onFilesPicked: (files: PickedItem[], accessToken: string) => void\n  storage: AsyncStore\n} & (\n  | {\n      pickerType: 'drive'\n      apiKey: string\n      appId: string\n    }\n  | {\n      pickerType: 'photos'\n      apiKey?: undefined\n      appId?: undefined\n    }\n)\n\nexport default function GooglePickerView({\n  uppy,\n  i18n,\n  clientId,\n  onFilesPicked,\n  pickerType,\n  apiKey,\n  appId,\n  storage,\n}: GooglePickerViewProps) {\n  const [loading, setLoading] = useState(false)\n  const [accessToken, setAccessTokenStored] = useStore(\n    storage,\n    `uppy:google-${pickerType}-picker:accessToken`,\n  )\n\n  const pickingSessionRef = useRef<PickingSession>()\n  const accessTokenRef = useRef(accessToken)\n  const shownPickerRef = useRef(false)\n\n  const setAccessToken = useCallback(\n    (t: string | null) => {\n      uppy.log('Access token updated')\n      setAccessTokenStored(t)\n      accessTokenRef.current = t\n    },\n    [setAccessTokenStored, uppy],\n  )\n\n  // keep access token in sync with the ref\n  useEffect(() => {\n    accessTokenRef.current = accessToken\n  }, [accessToken])\n\n  const showPicker = useCallback(\n    async (signal?: AbortSignal) => {\n      let newAccessToken = accessToken\n\n      const doShowPicker = async (token: string) => {\n        if (pickerType === 'drive') {\n          await showDrivePicker({ token, apiKey, appId, onFilesPicked, signal })\n        } else {\n          // photos\n          const onPickingSessionChange = (\n            newPickingSession: PickingSession,\n          ) => {\n            pickingSessionRef.current = newPickingSession\n          }\n          await showPhotosPicker({\n            token,\n            pickingSession: pickingSessionRef.current,\n            onPickingSessionChange,\n            signal,\n          })\n        }\n      }\n\n      setLoading(true)\n      try {\n        try {\n          await ensureScriptsInjected(pickerType)\n\n          if (newAccessToken == null) {\n            newAccessToken = await authorize({ clientId, pickerType })\n          }\n          if (newAccessToken == null) throw new Error()\n\n          await doShowPicker(newAccessToken)\n          shownPickerRef.current = true\n          setAccessToken(newAccessToken)\n        } catch (err) {\n          if (err instanceof InvalidTokenError) {\n            uppy.log('Token is invalid or expired, reauthenticating')\n            newAccessToken = await authorize({\n              pickerType,\n              accessToken: newAccessToken,\n              clientId,\n            })\n            // now try again:\n            await doShowPicker(newAccessToken)\n            shownPickerRef.current = true\n            setAccessToken(newAccessToken)\n          } else {\n            throw err\n          }\n        }\n      } catch (err) {\n        if (\n          err instanceof Error &&\n          'type' in err &&\n          err.type === 'popup_closed'\n        ) {\n          // user closed the auth popup, ignore\n        } else {\n          setAccessToken(null)\n          uppy.log(err)\n        }\n      } finally {\n        setLoading(false)\n      }\n    },\n    [\n      accessToken,\n      apiKey,\n      appId,\n      clientId,\n      onFilesPicked,\n      pickerType,\n      setAccessToken,\n      uppy,\n    ],\n  )\n\n  useEffect(() => {\n    const abortController = new AbortController()\n\n    pollPickingSession({\n      pickingSessionRef,\n      accessTokenRef,\n      signal: abortController.signal,\n      onFilesPicked,\n      onError: (err) => uppy.log(err),\n    })\n\n    return () => abortController.abort()\n  }, [onFilesPicked, uppy])\n\n  useEffect(() => {\n    // when mounting, once we have a token, be nice to the user and automatically show the picker\n    // accessToken === undefined means not yet loaded from storage, so wait for that first\n    if (accessToken === undefined || shownPickerRef.current) {\n      return undefined\n    }\n\n    const abortController = new AbortController()\n\n    showPicker(abortController.signal)\n\n    return () => {\n      // only abort the picker if it's not yet shown\n      if (!shownPickerRef.current) abortController.abort()\n    }\n  }, [accessToken, showPicker])\n\n  const handleLogoutClick = useCallback(async () => {\n    if (accessToken) {\n      await logout(accessToken)\n      setAccessToken(null)\n      pickingSessionRef.current = undefined\n    }\n  }, [accessToken, setAccessToken])\n\n  if (loading) {\n    return <div>{i18n('pleaseWait')}...</div>\n  }\n\n  if (accessToken == null) {\n    return (\n      <AuthView\n        pluginName={\n          pickerType === 'drive' ?\n            i18n('pluginNameGoogleDrivePicker')\n          : i18n('pluginNameGooglePhotosPicker')\n        }\n        pluginIcon={pickerType === 'drive' ? GoogleDriveIcon : GooglePhotosIcon}\n        handleAuth={showPicker}\n        i18n={i18n}\n        loading={loading}\n      />\n    )\n  }\n\n  return (\n    <div style={{ textAlign: 'center' }}>\n      <button\n        type=\"button\"\n        className=\"uppy-u-reset uppy-c-btn uppy-c-btn-primary\"\n        style={{ display: 'block', marginBottom: '1em' }}\n        disabled={loading}\n        onClick={() => showPicker()}\n      >\n        {pickerType === 'drive' ? i18n('pickFiles') : i18n('pickPhotos')}\n      </button>\n      <button\n        type=\"button\"\n        className=\"uppy-u-reset uppy-c-btn\"\n        disabled={loading}\n        onClick={handleLogoutClick}\n      >\n        {i18n('logOut')}\n      </button>\n    </div>\n  )\n}\n"],"mappings":"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","ignoreList":[]}